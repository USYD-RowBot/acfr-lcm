set (LCMTYPES_H ${CMAKE_CURRENT_BINARY_DIR}/lcmtypes.h)
set (LCMTYPES_H_INCLUDE ${INCLUDE_OUTPUT_PATH}/perls-lcmtypes/lcmtypes.h)

file (WRITE  ${LCMTYPES_H} "/* CMAKE AUTOGENERATED FILE - DO NOT EDIT BY HAND!! */\n")
file (APPEND ${LCMTYPES_H} "#ifndef __PERLS_LCMTYPES_H__\n")
file (APPEND ${LCMTYPES_H} "#define __PERLS_LCMTYPES_H__\n")
file (APPEND ${LCMTYPES_H} "\n")

# emit C lcmtypes
set (LCM_SRC "")
foreach (PACKAGE ${PERLS_LCM_PACKAGES})
  # round up .lcm definition files
  file (GLOB LCM_DEFS ${PERLS_LCMDEFS_DIR}/${PACKAGE}/*.lcm)

  foreach (LCM_DEF ${LCM_DEFS})
    get_filename_component (LCM_TYPE ${LCM_DEF} NAME_WE)
    set (LCM_TYPE_C ${CMAKE_CURRENT_BINARY_DIR}/${LCM_TYPE}.c)
    set (LCM_TYPE_H ${CMAKE_CURRENT_BINARY_DIR}/${LCM_TYPE}.h)
    set (INCLUDE_HEADER ${INCLUDE_OUTPUT_PATH}/perls-lcmtypes/${LCM_TYPE}.h)

    file (APPEND ${LCMTYPES_H} "#include \"${LCM_TYPE}.h\"\n")

    if (NOT EXISTS ${INCLUDE_OUTPUT_PATH}/perls-lcmtypes)
      file (MAKE_DIRECTORY ${INCLUDE_OUTPUT_PATH}/perls-lcmtypes)
    endif ()

    add_custom_command (
      OUTPUT ${LCM_TYPE_C} ${LCM_TYPE_H} ${INCLUDE_HEADER}
      COMMAND ${LCM_GEN_EXE} ${LCM_DEF} --lazy --c
      COMMAND cp -u -f ${LCM_TYPE_H} ${INCLUDE_HEADER}
      DEPENDS ${LCM_DEF}
      )

    set (LCM_SRC ${LCM_SRC} ${LCM_TYPE_C})
    set (LCM_HEADERS ${LCM_HEADERS} ${LCM_TYPE_H})
  endforeach ()
endforeach () #foreach (PACKAGE ${LCM_PACKAGES})

file (APPEND ${LCMTYPES_H} "\n")
file (APPEND ${LCMTYPES_H} "#endif //__PERLS_LCMTYPES_H__\n")

add_custom_command (
  OUTPUT ${LCMTYPES_H_INCLUDE}
  COMMAND cp -u -f ${LCMTYPES_H} ${LCMTYPES_H_INCLUDE}
  DEPENDS ${LCM_HEADERS} ${LCMTYPES_H}
  )

# EXTERNAL DEPS
perlsx_lcm ()

# BUILD LIBRARY
set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-unused-variable")
perls_add_library (perls-lcmtypes ${LCM_SRC} ${LCM_HEADERS} ${LCMTYPES_H_INCLUDE})
perls_target_link_libraries (perls-lcmtypes
  ${PERLSX_LCM}
  )

# INSTALL LCM-GENERATED HEADERS
install (FILES ${LCM_HEADERS} ${LCMTYPES_H}
  DESTINATION ${INCLUDE_INSTALL_PATH}/perls-lcmtypes
  PERMISSIONS OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ
  )
