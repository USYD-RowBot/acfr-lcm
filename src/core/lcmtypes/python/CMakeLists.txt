set (INIT_PY ${PYTHON_OUTPUT_PATH}/perls/lcmtypes/__init__.py)

file (WRITE  ${INIT_PY} "\"\"\"CMAKE AUTOGENERATED FILE - DO NOT EDIT BY HAND!!\"\"\"\n")
file (APPEND ${INIT_PY} "\n")

foreach (PACKAGE ${PERLS_LCM_PACKAGES})
  # round up .lcm definition files
  file (GLOB LCM_DEFS ${PERLS_LCMDEFS_DIR}/${PACKAGE}/*.lcm)

  # emit python lcmtypes
  set (LCM_SRC)
  foreach (LCM_DEF ${LCM_DEFS})
    get_filename_component (LCM_TYPE ${LCM_DEF} NAME_WE)
    string (REGEX REPLACE "^${PACKAGE}_" "" LCM_TYPE ${LCM_TYPE})
    set (LCM_TYPE_PY ${PYTHON_OUTPUT_PATH}/perls/lcmtypes/${PACKAGE}/${LCM_TYPE}.py)
    set (LCM_TYPES_PY ${LCM_TYPES_PY} ${LCM_TYPE_PY})
  endforeach ()
  
  set (LCM_TYPE_INIT_PY ${PYTHON_OUTPUT_PATH}/perls/lcmtypes/${PACKAGE}/__init__.py)
  set (LCM_TYPES_INIT_PY ${LCM_TYPES_INIT_PY} ${LCM_TYPE_INIT_PY})
  set (LCM_TYPES_SRC ${LCM_TYPES_SRC} ${LCM_DEFS})

  file (APPEND ${INIT_PY} "import ${PACKAGE}\n")
  file (APPEND ${INIT_PY} "\n")
endforeach () #foreach PACKAGE

# build local definitions
add_custom_command (
  OUTPUT ${LCM_TYPES_PY} ${LCM_TYPES_INIT_PY} ${INIT_PY}
  COMMAND ${LCM_GEN_EXE} ${LCM_TYPES_SRC} --lazy --python --ppath ${PYTHON_OUTPUT_PATH}/perls/lcmtypes
  DEPENDS ${LCM_TYPES_SRC}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  )

add_custom_target (perls-lcmtypes.py ALL
  DEPENDS ${LCM_TYPES_PY} ${LCM_TYPES_INIT_PY}
  )

install (DIRECTORY ${PYTHON_OUTPUT_PATH}/perls/lcmtypes
   DESTINATION ${PYTHON_INSTALL_PATH}/perls
   DIRECTORY_PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE
   PATTERN "*.pyc" EXCLUDE
  )

perls_python_add_custom_package (lcmtypes)
