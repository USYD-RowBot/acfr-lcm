<!DOCTYPE html>
<html>
    <head>
        <title>AUV trackview</title>
        <link rel="stylesheet" href="/static/leaflet-0.7.3/leaflet.css" />
        <link rel="stylesheet" href="/static/leaflet-measure/leaflet.measurecontrol.css" />
        <link rel="stylesheet" href="/static/leaflet-draw/dist/leaflet.draw.css" />
        <link href='/static/leaflet-fullscreen/dist/leaflet.fullscreen.css' rel='stylesheet' />
        <link href='/static/leaflet-mouseposition/src/L.Control.MousePosition.css' rel='stylesheet' />
        <link rel="stylesheet" href="/static/bootstrap-3.2.0-dist/css/bootstrap.min.css">
      <link rel="stylesheet" href="/static/jquery-ui.1.11.3.css">
          <link href="/static/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="/static/pnotify2.0/pnotify.custom.min.css" rel="stylesheet">
        <link href="/static/auvmapper.css" rel="stylesheet">

        <script src="/static/jquery-2.1.0.min.js"></script>
        <script src="/static/jquery-ui.1.11.3.js"></script>
        <script src="/static/pnotify2.0/pnotify.custom.min.js"></script>
        <script src="/static/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
        <script src="/static/leaflet-0.7.3/leaflet.js"></script>
        <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
        <script src="/static/leaflet-plugins/layer/tile/Google.js"></script>
{#        <script src="http://cdn-geoweb.s3.amazonaws.com/esri-leaflet/1.0.0-rc.5/esri-leaflet.js"></script>#}
        <script src='/static/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js'></script>
        <script src="/static/leaflet-mouseposition/src/L.Control.MousePosition.js"></script>
{#        <script src="/static/leaflet-heat/dist/leaflet-heat.js"></script>#}


        <script src="/static/leaflet-draw/dist/leaflet.draw.js"></script>
        <script src="/static/leaflet-plugins/control/Permalink.js"></script>
{#        <script src="/static/leaflet-plugins/control/Permalink.Line.js"></script>#}
{#        <script src="/static/leaflet-plugins/control/Permalink.Layer.js"></script>#}
        <!--<script src="/static/leaflet-plugins/control/Scale.js"></script>-->
        <script src="/static/leaflet-measure/leaflet.measurecontrol.js"></script>
        <script src="/static/leaflet-plugins/layer/vector/KML.js"></script>

        <script src="/static/bootstrap-plugins/bootbox.min.js"></script>

        <script src="/static/jQuery-Knob/dist/jquery.knob.min.js"></script>
        <script src="/static/auvmapper.js"></script>
    </head>
    <body>
        <div id="notify" class="alert alert-info alert-dismissible" role="alert" style="position: absolute; z-index: 1000; margin: 10px 20%; display: none;">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <div id="notify-text"></div>

        </div>
        <div style="width:500px; height:500px; background: #387486" id="map">
            <!--This is the div that contains all the magic-->
        </div>

        <!-- Modal -->
        <div class="modal" id="modal" tabindex="-1" role="dialog" aria-hidden="true" >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-body">
                <a href="javascript:void(0)" class="pull-right close" data-dismiss="modal"><i class="fa fa-times"></i></a>
                <div id="modalcontent"></div>
              </div>
            </div>
          </div>
        </div>

        <script type='text/javascript'>

            // Create the map object - subscribe to an address
            var cfgfile = "{{ configfile }}"; // server from template address
            var allowadmin = {{ allowadmin }}
            if (allowadmin && window.location.hash == "#display") allowadmin = false
            var map = new auvmapper();



            $(window).resize(function () {
                map.fullsize();
            });
            $(window).ready(function(){
                // initialise map
                map.init("map");


                // Add settings modal control
                if (allowadmin)
                    map.add_control("<i class='fa fa-gear'></i>", function () {show_modalform ("/get_config?cfg="+cfgfile) }, "Settings", "topright");
                    //map.add_control("<i class='fa fa-gear'></i>", function () {$("#modalform-modal").modal("show")}, "Settings", "topright");

                map.add_control("<i class='fa fa-info-circle'></i>", function() {show_modalform('static/html-snippets/systeminfo.html')}, "Info", "topright");

                // Add settings modal control
                map.add_control("<i class='fa fa-crosshairs'></i><ul id='track-layers'></ul>", function(){return 0},"Move in to view","topleft");
                $("#track-layers").parent().addClass("hover-expand");

                // Load layers from config file
                loadlayersfromcfg("/get_config",cfgfile);


                show_notify('{{ welcomenote }}');
                /*
                new PNotify({
                    title: 'Welcome!',
                    text: 'On this page you can see robots in action collecting underwater images! <b><a href="http://helpscience.marine.acfr.usyd.edu.au" target="_blank">Click here to help label the images!</a></b>',
                    hide: false
                });
                */

            });


            function show_notify(fileurl) {
                if (fileurl != "") {
                    $("#notify-text").load(fileurl);
                    $("#notify").show(1000);
                }
            }

            /**
             * Get the list of layers from the config file
             * @param url
             * @param cfg
             */
            function loadlayersfromcfg (url, cfg) {
                get_config(url, cfg, 'layers', load_layers);
            }


            /**
             * Load the layers from the config file for each of the layer types
             * @param data
             * @param url
             * @param cfg
             */
            function load_layers(data, url, cfg) {

                // load targets
                if (data.hasOwnProperty('targets')) {
                    var targets = data.targets.split(',');
                    var size, inputoptions, dispoptions, maxtracklen;
                    for (var i = 0; i < targets.length; i++)
                        get_config(url, cfg, targets[i].trim(), function (data, url, cfg) {
                            inputoptions = data.options.split(',');
                            dispoptions = {};
                            for (var i = 0; i < inputoptions.length; i++) dispoptions[inputoptions[i].trim()] = true;
                            size = (data.hasOwnProperty("size")) ? parseInt(data.size) : {width: parseInt(data.width), length: parseInt(data.length), loffset: parseInt(data.loffset)};
                            maxtracklen = (data.hasOwnProperty("maxtracklen")) ? parseInt(data.maxtracklen) : 100;
                            map.add_posetracker(data.name, data.url, {color: data.color, dispoptions: dispoptions, interval: parseInt(data.interval), size: size, maxtracklen: maxtracklen}, allowadmin);
                            if (dispoptions.hasOwnProperty("autotrack")) map.auto_extent(data.name, true);
                        });
                }
                // load geotiffs
                if (data.hasOwnProperty('geotiffs')) {
                    var geotiffs = data.geotiffs.split(',');
                    for (var i = 0; i < geotiffs.length; i++)
                        get_config(url, cfg, geotiffs[i].trim(), function (data, url, cfg) {
                            map.get_geotiff(data.name, data.filepath, "/get_geotiff");
                        });
                }
                // load missions
                if (data.hasOwnProperty('missions')) {
                    var missions = data.missions.split(',');
                    for (var i = 0; i < missions.length; i++)
                        get_config(url, cfg, missions[i].trim(), function (data, url, cfg) {
                            // check is there is an origin specified in the cfg and pass it in if it does
                            if (data.hasOwnProperty('origin_lat') && data.hasOwnProperty('origin_lon')) {
                                var origin = [data.origin_lat , data.origin_lon];
                                map.get_mission(data.name, data.filepath, "/get_mission", {color: data.color}, origin);
                            }
                            else
                                map.get_mission(data.name, data.filepath, "/get_mission", {color: data.color});
                        });
                }
                // load kmls
                if (data.hasOwnProperty('kmls')) {
                    var kmls = data.kmls.split(',');
                    for (var i = 0; i < kmls.length; i++)
                        get_config(url, cfg, kmls[i].trim(), function (data, url, cfg) {
                            map.get_kml(data.name, data.filepath);
                        });
                }
                // load tilelayers
                if (data.hasOwnProperty('tilelayers')) {
                    var tilelayers = data.tilelayers.split(',');
                    var defaultbase = "";
                    for (var i = 0; i < tilelayers.length; i++) {
                        get_config(url, cfg, tilelayers[i].trim(), function (data, url, cfg) {
                            if (data.type === "baselayer") {
                                if (defaultbase == "") defaultbase = data.name;
                                var attribution = (data.hasOwnProperty('attribution')) ? data.attribution : ""
                                map.layers.base[data.name] = new L.TileLayer(data.url, {maxNativeZoom: data.maxzoom, maxZoom: map.map.maxZoom, attribution: attribution});
                                map.layerctl.addBaseLayer(map.layers.base[data.name], data.name);
                            }
                            else if (data.type === "overlay") {
                                var opacity = (data.hasOwnProperty("opacity")) ? data.opacity : 1;
                                map.layers.overlays[data.name] = new L.TileLayer(data.url, {maxNativeZoom: data.maxzoom, maxZoom: map.map.maxZoom, opacity: opacity});
                                map.layerctl.addOverlay(map.layers.overlays[data.name], data.name);
                            }
                            else if (data.type === "google-baselayer") {
                                map.layers.base[data.name] = new L.Google(data.url);
                                map.layerctl.addBaseLayer(map.layers.base[data.name], data.name);
                            }
                        });
                    }
                    // activate first base layer
                    map.layers.base[defaultbase].addTo(map.map);
                }



                // load iframes
                if (data.hasOwnProperty('iframes')) {
                    var iframes = data.iframes.split(',');
                    for (var i = 0; i < iframes.length; i++)
                        get_config(url, cfg, iframes[i].trim(), function (data, url, cfg) {
                            var iframeid = "iframe-"+ i, obj;
                            obj = map.add_control("<i class='fa fa-"+data.icon+"'></i>", function(e){
                                if($("#"+iframeid).length > 0) {
                                    $("#"+iframeid).remove();
                                    $(this).removeClass("active");
                                }
                                else {
                                    var $iframepane = $("<div id='"+iframeid+"' class='iframe' style='"+data.css+"'><div class=iframe-title><i class='fa fa-"+data.icon+"'></i> "+data.name+"</div></div>")
                                    $("body").append($iframepane);
                                    var iframeheight = $iframepane.height()-30;
                                    $iframepane.append("<iframe style='height: "+iframeheight+"px' src='"+data.url+"'></iframe>").draggable({containment: "#map", scroll: false});
                                    $(this).addClass("active");
                                }
                            },data.name,"topright");
                            //if (data.show === "true") {
                            //    $("body").append($("<div id='"+iframeid+"' class='iframe' style='"+data.css+"'><div class=iframe-title><i class='fa fa-plus-square'></i> "+data.name+"</div><iframe src='"+data.url+"'></iframe></div>").draggable({containment: "#map", scroll: false}));
                            //}
                        });
                }
            }


            function get_config (url, cfg, sec, callbackfnc) {
                var dataurl = url+"?cfg="+cfg+"&sec="+sec;
                $.ajax({
                    dataType: "jsonp",
                    url: dataurl,
                    async: false,                    // prevent async to return variables
                    success: function (data) {
                        callbackfnc(data, url, cfg);
                    },
                    error : function (jqXHR, status, desc) {
                        console.log("Cannot load config for: "+cfg+">"+sec+" "+desc);
                    }
                });
            }

            function show_modalform (htmlurl) {
                $("#modalcontent").load(htmlurl,function(){
                    $("#modal").modal("show");
                })
            }

        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-61292123-1', 'auto');
          ga('require', 'linkid', 'linkid.js');
          ga('send', 'pageview');

        </script>
    </body>
</html>
